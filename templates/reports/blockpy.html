<h2 id='{{ assignment.slug() }}'>{{ assignment.name }}</h2>

{% set hiding = assignment.hidden or assignment.get_setting('hide_submission', False) %}

{% if is_grader or not hiding %}
<div class="module mb-2 m-2">
 <a class="read-more collapsed" data-toggle="collapse" href="#collapse-instructions-{{ assignment.slug() }}" role="button"></a>
  <div class="collapse" id="collapse-instructions-{{ assignment.slug() }}" aria-expanded="false">
    {{ assignment.instructions|markdown|safe }}
  </div>
</div>
{% endif  %}

{% if assignment.reviewed %}
    <script type='text/javascript'>

    $(function() {
        let target = 'reviewable-code-area-{{ submission.id }}';

        let loggedInUser = {{ g.user.encode_json()|tojson }};
        let submissionId = {{ submission.id|tojson }};
        let submission = {{ submission.encode_json()|tojson }};
        let assignment = {{ assignment.encode_json()|tojson }};
        let reviews = {{ submission.get_reviews()|tojson }};
        let metaReviews = {{ submission.get_meta_reviews()|tojson }};
        let tags = {{ tags|tojson }};
        let isGrader = ko.observable({{ is_grader|tojson }});
        let mainReviewInterface = ko.observable(null);
        // Improve this check
        let isLtiActive = {{ (True == (session['is_lti_active'] and g.course and g.course.id == submission.course_id))|tojson }};

        $("#"+target).prepend($(`<submission-review-interface
            params="server: server,
            submission: submission,
            assignment: assignment,
            author: author,
            reviews: reviews,
            reviewInterfaces: reviewInterfaces,
            genericReviews: genericReviews,
            tags: tags,
            isGrader: isGrader,
            isLtiActive: isLtiActive,
            canSeeFeedback: canSeeFeedback,
            canEditFeedback: canEditFeedback,
            mainReviewInterface: mainReviewInterface"
        />`));

        const COMMENT_COLUMN = $("<td class='comment-column'></td>");
        $(`#${target} .highlighttable`).find("td.code").after(COMMENT_COLUMN);
        $(`#${target} .highlighttable span[id^='code-span-']`).each(function(index, elem) {
            let parameters = (
                "location: "+index+
                ", reviews: reviewInterfaces"+
                ", isGrader: isGrader"+
                ", canSeeFeedback: canSeeFeedback"+
                ", canEditFeedback: canEditFeedback"+
                ", parent: mainReviewInterface");
            let button = $("<line-review params='"+parameters+"'></line-review>");
            button.css({"top": elem.top});
            COMMENT_COLUMN.append(button);
        });

        server = new frontend.Server({{ course_id|tojson }}, {
            submissionIds: [submissionId]
        }, {
            users: [loggedInUser],
            submissions: [submission],
            reviews: reviews.concat(metaReviews),
            tags: tags
        });
        //console.log({server, submission, assignment, reviews, metaReviews, tags});
        let editModel = {
            server: server,
            reviewInterfaces: ko.observableArray([]),
            submission: server.submissionStore.getInstance(submission.id),
            assignment: server.assignmentStore.getInstance(assignment.id),
            author: server.userStore.getInstance(loggedInUser.id),
            reviews: reviews.map((review) => server.reviewStore.getInstance(review.id)),
            genericReviews: metaReviews.map((review) => server.reviewStore.getInstance(review.id)),
            tags: tags,
            isGrader: isGrader,
            isLtiActive: isLtiActive,
            canSeeFeedback: ko.pureComputed(() => isGrader() || server.submissionStore.getInstance(submission.id).isFullyGraded()),
            canEditFeedback: ko.pureComputed(() => isGrader()),
            mainReviewInterface: mainReviewInterface
        }
        ko.applyBindings(editModel, document.getElementById(target));
    });

    </script>
    {# include "helpers/review_interface.html" with context #}
{% endif %}

<div class="col-md-12">

{% if is_grader or not hiding %}
<div class="col-xl-6 col-md-12 mb-2">
<form method="post" target="_blank" action="{{ url_for("blockpy.load_readonly", embed=True) }}"
    style="display:inline">
    <input type="hidden" name="assignment_data" value="{{
        assignment|make_readonly_form(submission, is_grader)
    }}">
    <input type="hidden" name="access_token" value="{{ g.access_token }}">
    <button type="submit" class="btn btn-sm btn-outline-secondary"
>Load Read-only Mode</button>
</form> Opening assignment in read-only mode will not affect your grade at all.
</div>
{% endif %}

{% if is_grader %}
<div class="col-xl-6 col-md-12 mb-2">
    <a href="{{ url_for('blockpy.load_assignment',
                        assignment_id=submission.assignment_id,
                        user_id=submission.user_id,
                        course_id=submission.course_id,
                        force_download=True,
                        embed=True) }}"
                        class="btn btn-sm btn-outline-secondary">Download Full Submission</a>
                        Provides a JSON representation of this submission.
</div>

<div class="col-xl-6 col-md-12 mb-2">
    <a href="{{ url_for('blockpy.browse_history', assignment_id=submission.assignment_id,
            user_id=submission.user_id, course_id=submission.course_id, embed=True) }}"
            type="button" class="btn btn-sm btn-outline-secondary"
            >View History
            {% if is_grader %}
            <span class="badge badge-secondary">{{ submission.version }} edits</span>
            {% endif %}
            </a> Shows all events registered for this problem.
</div>
{% endif %}

<table class="table table-sm table-bordered table-condensed table-striped table-hover">
<thead>
    <tr>
        <th>Submission</th>
        <th>Grading</th>
        <th>Score</th>
        <th>Created</th>
        <th>Last Edited</th>
</tr>
</thead>
<tbody>
<tr>
    <td id="summary-submission-status-{{ submission.id }}">{{ submission.human_submission_status() }}</td>
    <td id="summary-grading-status-{{ submission.id }}">{{ submission.human_grading_status() }}</td>
    <td id="summary-score-status-{{ submission.id }}">{{ submission.full_status() }}</td>
    <td>{{ submission.date_created| date_description }}</td>
    <td>{{ submission.date_modified| date_description }}</td>
</tr>
</tbody>
</table>

<!-- TODO: Use the LTI information to build the proper URL
<div>Open in Canvas: <a href='' target='_blank'>View</a></div>
<div>Instructor Link: <a href='' target='_blank'>View</a></div>
-->





</div>
<div class="col-md-12">

<!--<div>Estimated Duration: {{ (submission.version/10.0)|round(2) }} minutes</div>-->

{% if is_grader or not hiding %}
<div id="reviewable-code-area-{{ submission.id }}">Submitted code:<br>
    {{ submission.code|highlight_python_code|safe }}
    {% if submission.extra_files %}
        {% for filename, contents in (submission.extra_files|json_load).items() %}
            <strong>{{ filename }}</strong>
            {{ contents|highlight_python_code|safe }}
        {% endfor %}
    {% endif %}
</div>

{% set turtle_output = submission.get_image('turtle_output') %}
{% if turtle_output %}
    <div>Turtle Output: <br>
        <img alt='Image of Turtle Output' src='{{ turtle_output }}'
        style="border: 1px solid lightgray">
    </div>
{% endif %}
{% set image = submission.get_block_image() %}
{% if image %}
    <div>Submitted Blocks: <br>
        <img alt='Block version of code' src='{{ image }}'>
    </div>
{% endif %}

{% endif %}

{% if is_grader %}
    <div><small>

        Assignment: {{ submission.assignment_id }} ({{ submission.assignment.name }}),
        User: {{ submission.user_id }} ({{ submission.user.name() }}),
        Course: {{ submission.course_id }} ({{ submission.course.name }})

    </small></div>

{% endif %}
</div>